# NX

### 모노레포에서의 주요 도전 과제:

- 속도: PR이 CI 검사를 통과하여 Main Branch 속도는 개발자 생산성에 직접적인 영향을 미칩니다.
- 복잡성: 모노레포 CI 제공자에 대한 기능 부족으로 복잡한 스크립트를 유지 관리해야 하는 부담이 증가합니다.
- 컴퓨터 비용: 정적 스크립트 PR 크기에 따라 컴퓨팅 자원과 속도 간의 균형을 맞추기 위해 과도한 자원일 필요로 합니다.

### 빠른 CI를 위한 솔루션:

- 원격 캐싱: 로컬 캐시를 중앙 NX Cloud에 연결하여 여러 사용자와 CI 시스템이 이를 활용할 수 있게 하여 큰 시간을 절약을 가능하게 함.
- 작업 분배: 작업을 여러 머신에 동적으로 분배하여 CI 속도를 30~70% 향상시키고 컴퓨터 비용을 40~75% 줄임.

### 구현 단계:

- NX 레포를 Github에 push하고 NX Cloud에 연결.
- NX Cloud 토큰 및 엔트포인트를 통합하는 PR 병합.
- 단순한 CI 설정 라인을 통해 작업 분배를 활성화하고, NX 에이전트를 활용하여 동적으로 작업 할당.

### End to End Test 최적화:

- End to End Test를 세분화된 작업으로 나누어 머신에 쉽게 분배.
- 캐싱 해시 키를 사용하여 불안정한 작업을 식별하고 재실행하여 깨끗한 설정을 보장하며 비용 절감.

### 디버깅 및 모니터링 향상:

- NX Cloud 대시보드를 통해 개별 작업 실행 및 머신 수준 로그를 검사.
- 로그와 아티팩트를 주 CI 작업으로 동기화하여 원활한 모니터링을 제공.
- CircleCI를 트리거로 사용하여 NX Cloud 분배를 실행함으로써 월 $6K에서 $3.2K로 비용 절감.

## 왜 NX Cloud인가?

작업 공간이 커짐에 따라 모든 프로젝트를 다시 테스트하고 다시 빌드하고 다시 re-linting 하는 작업이 너무 느려집니다.
이 문제점들을 해결하기 위해 NX 을 도입하게 됩니다.

```javascript
nx affected -t <task>
```

을 실행하면 Nx는 Git을 사용하여 PR에서 변경한 파일을 확인 후, 변경의 성격을 nx affected -t test살펴보고, 이를 사용하여 작업 공간에서 변경한 프로젝트 목록을 확인합니다.
이번 변경으로 인해 영향을 받을 수 있습니다.

예를 들어, 내 PR이 변경된 lib10 실행하면 nx affected -t test Nx는 프로젝트 그래프를 활용하여 의존하는 모든 프로젝트를 확인하고 lib10 `영향을 받음`을 표시한 후 test 해당 프로젝트 하위 집합에서만 실행됩니다.

### 영향을 받는 프로젝트 시각화

https://nx.dev/features/explore-graph
Nx 그래프를 사용하여 영향을 받는 프로젝트를 시각화할 수 있습니다.

```javascript
nx affected:graph
```

### 영향을 받는 코드를 계산하는 데 사용할 SHA 지정

어떤 프로젝트가 영향을 받는지 이해하기 위해 Nx는 Git 기록과 프로젝트 그래프를 사용합니다.
Git은 어떤 파일이 변경되었는지 알고 있으며 Nx 프로젝트 그래프는 해당 파일이 어떤 프로젝트에 속하는지 알고 있습니다.

영향을 받는 명령은 base 및 head 커밋을 수행합니다.
기본값 base은 main분기이고 기본값은 head현재 파일 시스템입니다.
이는 일반적으로 local에서 개발할 떄 원하는 것이지만, CI 에서는 이러한 값을 사용해 정의해야 합니다.

```javascript
nx affected:build --base=origin/main --head=$PR_BRANCH_NAME # where PR_BRANCH_NAME is defined by your CI system
nx affected:build --base=origin/main~1 --head=origin/main # rerun what is affected by the last commit in main
```

기본 및 Head SHA를 env 변수로 설정할 수도 있습니다.

```javascript
NX_BASE=origin/main~1
NX_HEAD=origin/main
```

main 일반적으로 기본 SHA를 브랜치의 가장 최근 커밋이 아니라 CI에서 성공적으로 전달된 최신 커밋으로 설정하려고 합니다.
즉, repo가 좋은 상태인지 확인하기 위해서는 지난번 repo가 좋은 상태였던 이후 발생한 모든 변경 사항을 확인해야 합니다.

https://nx.dev/ci/recipes/set-up/monorepo-ci-github-actions#get-the-commit-of-the-last-successful-build

/// 0----

### 영향을 받는 명령에서 파일 무시

`affected:*` Nx는 명령에서 glob패턴 (파일 및 폴더)를 제외하는 2가지 방법을 제공합니다.

- 파일에 정의된 Glob 패턴은 `.gitignore` 무시됩니다.
- 선택적 `.nxignore` 파일에 정의된 Glob 패턴은 무시됩니다.

### Nx 독립 실행형 설정으로 React 앱 구축

- 새로운 React 애플리케이션을 만드는 방법
- 단일 작업(예: 앱 제공)을 실행하거나 여러 작업을 병렬로 실행하는 방법
- 코드 생성기를 활용하여 구성 요소를 비계하는 방법
- 더 나은 유지 관리를 위해 코드베이스를 모듈화하고 아키텍처 제약을 적용하는 방법

### Use Remote Caching (Nx Replay)

기본적으로 Nx는 작업 계산을 로컬로 캐시합니다.
그러나 팀 전체, 특히 CI에서 캐시를 활용하기 위해 계산 캐시를 여러 시스템에 분산할 수도 있습니다.

Nx Cloud의 Nx Replay 빠르게 안전하며 구성이 필요 없는 원격 캐싱 구현입니다.

### Nx Replay의 장점

- Nx Replay가 조직에 직접적인 이점을 주는 2가지 방법이 있습니다.

1. 수정된 PR을 위한 CI 파이프라인 속도 향상

- PR이 CI 파이프라인을 처음 통과할 떄 영향을 받는 명령은 대부분의 시간 절약을 제공합니다. 이 affected 명령은 PR을 분기와 비교 main 하고 코드 변경으로 영향을 받을 수 있는 프로젝트에 대해서만 작업을 실행합니다.
  불행하게도 PR에 첫 번쨰 CI 파이프라인의 영향을 받는 모든 프로젝트는 해당 PR에 대한 모든 향후 커밋의 영향을 계속 받게 됩니다. 매번 affected 현재 커밋을 브랜치와 비교하기 떄문입니다.

Nx Replay가 활성화되면 첫 번쨰 파이프라인에서 실행되고 두 번쨰 커밋의 영향을 받지 않는 모든 작업의 작업을 다시 실행하는 대신 첫 번쨰 파이프라인에서 캐시된 결과를 재사용합니다.
이를 통해 후속 파이프라인 실행에 영향을 받은 것과 유사한 메커니즘이 제공되어 CI에서 낭비되는 시간이 줄어듭니다.

2. 개발자 컴퓨터에서 CI의 캐시된 결과 재사용

CI에서 작업이 실행된 경우 동일한 작업을 로컬로 실행하는 개발자는 실제로 작업을 실행하는 대신 작업 결과를 재사용할 수 있습니다.

## 작업 실행 분산 (Nx 에이전트)

Nx 에이전트를 사용하면 최소한의 구성으로 여러 시스템에 CI를 배포할 수 있습니다.

- PR 규모에 따라 Agent 수와 규모를 동적으로 할당.
- CI에서 실패할 떄마다 불안정한 작업을 자동으로 다시 실행
- 대규모 e2e 작업을 보다 효율적으로 배포할 수 있는 작은 작업으로 자동 분할

### 분산 CI 파이프라인 구축의 어려움

필요한 모든 작업을 실행하면서 CI 파이프라인 속도를 높이는 유일한 방법은 작업을 여러 머신에 분배하는 것 입니다.
그러나 분산 설정과 유지보수는 어렵습니다. 고려해야 할 사항은 다음과 같음.

- 설정할 머신 수를 선택.
- 각 머신을 작업 실행 준비
- 작업이 올바른 순서로 실행되는지 확인
- 특정 작업의 출력을 필요한 머신으로 복사
- 작업이 더 이상 없을 떄 머신 종료
- 파이프라인 전체가 오류가 발생하면 모든 머신 종료
- 모든 머신에서 민감한 정보가 안전하게 처리되는지 확인

이러한 고려 사항은 코드베이스 변경될 떄마다 재검토해야 하며, 작업 PR은 큰 PR만큼 많은 분배가 필요하지 않기 떄문에 PR마다 재검토하는 것이 가장 좋습니다.

### Nx 에이전트로 작업 분배 간소화

Nx 에이전트는 코드베이스가 변경되어도 수정할 필요가 없는 소량의 초기 설정으로 이러한 모든 문제를 해결합니다.
CI 파이프라인은 Nx 클라우드가 생성한 에이전트 머신에서 작업을 실행하도록 보냅니다.
에이전트 수와 에이전트 유형만 지정하면 됩니다.
파이프라인이 완료되면 초기 CI 파이프라인은 마치 모든 작업이 메인 CI 머신에서 실행된 것처럼 로그와 아티팩트를 포함하지만, 훨씬 짧은 시간에 완료됩니다.

### Nx 에이전트를 이용한 작업 실행 분배

CI 파이프라인을 최적화하는 Nx 에이전트의 자세한 설명은 CI에서 병렬화와 분배에 관한 가이드 참조하기.

### Nx 에이전트 활성화

Nx 에이전트를 사용하여 작업 분배를 활성화하려면 두 가지 요구 사항이 있습니다:

1. 버전 관리 시스템 통합 활성화, 현재 가능한 통합은 GitHub, GitLab, Bitbucket 및 Azure DevOps입니다. Nx 클라우드 대시보드에서 이 통합을 활성화할 수 있습니다.
2. CI 파이프라인 설정 파일에 한 줄 추가, 저장소를 체크아웃한 후, node_modules를 설치하기 전에 start-ci-run 명령을 추가하기.

```yaml
.github/workflows/main.yaml
# After checkout repository
- name: Start CI run
   run: 'npx nx-cloud start-ci-run --distribute-on="8 linux-medium-js"'
# Before install node_modules
# Run any nx commands as if running on a single machine
```

--distribute-on 플래그는 Nx 클라우드에 작업을 8개의 linux-medium-js 유형 에이전트에 분배하도록 지시합니다.
linux-medium-js는 에이전트를 프로비저닝하는 데 사용될 시작 템플릿의 이름입니다.
기본 시작 템플릿 중 하나를 사용하거나 사용자 정의 시작 템플릿을 생성하기.

### Nx 에이전트 기능

- 사용자 정의 시작 템플리 생성: 에이전트를 정확하게 설정하는 사용자 정의 템플릿 정의
- 에이전트 동적 할당: PR 크기에 따라 파이프라인에 다른 수의 에이전트 할당
- E2E 작업 자동 분할: 큰 e2e 작업을 각 스펙 파일에 대한 개별 작업으로 분할
- 불안전한 작업 식별 및 재실행: CI에서 실패할 경우 불안정한 작업 재실행

### 관련 저장소 및 예제

- Nx: 작은 설정 변경으로 CI 속도를 16배 빠르게 만드는 방법
- Lerna & 분산 작업 실행 예제
